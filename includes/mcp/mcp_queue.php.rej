*** includes/mcp/mcp_queue.php	2013-09-28 15:40:10.000000000 +0200
--- includes/mcp/mcp_queue.php	2015-05-03 17:14:55.000000000 +0200
***************
*** 571,1142 ****
  						'U_POST_AUTHOR'			=> get_username_string('profile', $row['poster_id'], $row['username'], $row['user_colour'], $row['post_username']),
  
  						'POST_ID'		=> $row['post_id'],
! 						'FORUM_NAME'	=> (!$global_topic) ? $forum_names[$row['forum_id']] : $user->lang['GLOBAL_ANNOUNCEMENT'],
  						'POST_SUBJECT'	=> ($row['post_subject'] != '') ? $row['post_subject'] : $user->lang['NO_SUBJECT'],
  						'TOPIC_TITLE'	=> $row['topic_title'],
! 						'POST_TIME'		=> $user->format_date($row['post_time']))
! 					);
  				}
  				unset($rowset, $forum_names);
  
  				// Now display the page
  				$template->assign_vars(array(
! 					'L_DISPLAY_ITEMS'		=> ($mode == 'unapproved_posts') ? $user->lang['DISPLAY_POSTS'] : $user->lang['DISPLAY_TOPICS'],
! 					'L_EXPLAIN'				=> ($mode == 'unapproved_posts') ? $user->lang['MCP_QUEUE_UNAPPROVED_POSTS_EXPLAIN'] : $user->lang['MCP_QUEUE_UNAPPROVED_TOPICS_EXPLAIN'],
! 					'L_TITLE'				=> ($mode == 'unapproved_posts') ? $user->lang['MCP_QUEUE_UNAPPROVED_POSTS'] : $user->lang['MCP_QUEUE_UNAPPROVED_TOPICS'],
  					'L_ONLY_TOPIC'			=> ($topic_id) ? sprintf($user->lang['ONLY_TOPIC'], $topic_info['topic_title']) : '',
  
  					'S_FORUM_OPTIONS'		=> $forum_options,
  					'S_MCP_ACTION'			=> build_url(array('t', 'f', 'sd', 'st', 'sk')),
! 					'S_TOPICS'				=> ($mode == 'unapproved_posts') ? false : true,
  
- 					'PAGINATION'			=> generate_pagination($this->u_action . "&amp;f=$forum_id&amp;st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir", $total, $config['topics_per_page'], $start),
- 					'PAGE_NUMBER'			=> on_page($total, $config['topics_per_page'], $start),
  					'TOPIC_ID'				=> $topic_id,
! 					'TOTAL'					=> ($total == 1) ? (($mode == 'unapproved_posts') ? $user->lang['VIEW_TOPIC_POST'] : $user->lang['VIEW_FORUM_TOPIC']) : sprintf((($mode == 'unapproved_posts') ? $user->lang['VIEW_TOPIC_POSTS'] : $user->lang['VIEW_FORUM_TOPICS']), $total),
  				));
  
  				$this->tpl_name = 'mcp_queue';
  			break;
  		}
  	}
- }
  
! /**
! * Approve Post/Topic
! */
! function approve_post($post_id_list, $id, $mode)
! {
! 	global $db, $template, $user, $config;
! 	global $phpEx, $phpbb_root_path;
! 
! 	if (!check_ids($post_id_list, POSTS_TABLE, 'post_id', array('m_approve')))
  	{
! 		trigger_error('NOT_AUTHORISED');
! 	}
  
! 	$redirect = request_var('redirect', build_url(array('quickmod')));
! 	$success_msg = '';
  
! 	$s_hidden_fields = build_hidden_fields(array(
! 		'i'				=> $id,
! 		'mode'			=> $mode,
! 		'post_id_list'	=> $post_id_list,
! 		'action'		=> 'approve',
! 		'redirect'		=> $redirect)
! 	);
  
! 	$post_info = get_post_data($post_id_list, 'm_approve');
  
! 	if (confirm_box(true))
! 	{
! 		$notify_poster = (isset($_REQUEST['notify_poster'])) ? true : false;
  
! 		// If Topic -> total_topics = total_topics+1, total_posts = total_posts+1, forum_topics = forum_topics+1, forum_posts = forum_posts+1
! 		// If Post -> total_posts = total_posts+1, forum_posts = forum_posts+1, topic_replies = topic_replies+1
  
! 		$total_topics = $total_posts = 0;
! 		$topic_approve_sql = $post_approve_sql = $topic_id_list = $forum_id_list = $approve_log = array();
! 		$user_posts_sql = $post_approved_list = array();
  
! 		foreach ($post_info as $post_id => $post_data)
! 		{
! 			if ($post_data['post_approved'])
  			{
! 				$post_approved_list[] = $post_id;
! 				continue;
! 			}
  
! 			$topic_id_list[$post_data['topic_id']] = 1;
  
! 			if ($post_data['forum_id'])
  			{
! 				$forum_id_list[$post_data['forum_id']] = 1;
  			}
  
! 			// User post update (we do not care about topic or post, since user posts are strictly connected to posts)
! 			// But we care about forums where post counts get not increased. ;)
! 			if ($post_data['post_postcount'])
  			{
! 				$user_posts_sql[$post_data['poster_id']] = (empty($user_posts_sql[$post_data['poster_id']])) ? 1 : $user_posts_sql[$post_data['poster_id']] + 1;
  			}
  
! 			// Topic or Post. ;)
! 			if ($post_data['topic_first_post_id'] == $post_id)
  			{
! 				if ($post_data['forum_id'])
  				{
! 					$total_topics++;
  				}
! 				$topic_approve_sql[] = $post_data['topic_id'];
  
! 				$approve_log[] = array(
! 					'type'			=> 'topic',
! 					'post_subject'	=> $post_data['post_subject'],
! 					'forum_id'		=> $post_data['forum_id'],
! 					'topic_id'		=> $post_data['topic_id'],
! 				);
  			}
  			else
  			{
! 				$approve_log[] = array(
! 					'type'			=> 'post',
! 					'post_subject'	=> $post_data['post_subject'],
! 					'forum_id'		=> $post_data['forum_id'],
! 					'topic_id'		=> $post_data['topic_id'],
! 				);
  			}
  
! 			if ($post_data['forum_id'])
  			{
! 				$total_posts++;
  
! 				// Increment by topic_replies if we approve a topic...
! 				// This works because we do not adjust the topic_replies when re-approving a topic after an edit.
! 				if ($post_data['topic_first_post_id'] == $post_id && $post_data['topic_replies'])
  				{
! 					$total_posts += $post_data['topic_replies'];
  				}
  			}
  
! 			$post_approve_sql[] = $post_id;
  		}
  
! 		$post_id_list = array_values(array_diff($post_id_list, $post_approved_list));
! 		for ($i = 0, $size = sizeof($post_approved_list); $i < $size; $i++)
! 		{
! 			unset($post_info[$post_approved_list[$i]]);
! 		}
  
! 		if (sizeof($topic_approve_sql))
! 		{
! 			$sql = 'UPDATE ' . TOPICS_TABLE . '
! 				SET topic_approved = 1
! 				WHERE ' . $db->sql_in_set('topic_id', $topic_approve_sql);
! 			$db->sql_query($sql);
! 		}
  
! 		if (sizeof($post_approve_sql))
  		{
! 			$sql = 'UPDATE ' . POSTS_TABLE . '
! 				SET post_approved = 1
! 				WHERE ' . $db->sql_in_set('post_id', $post_approve_sql);
! 			$db->sql_query($sql);
  		}
  
! 		unset($topic_approve_sql, $post_approve_sql);
  
! 		foreach ($approve_log as $log_data)
! 		{
! 			add_log('mod', $log_data['forum_id'], $log_data['topic_id'], ($log_data['type'] == 'topic') ? 'LOG_TOPIC_APPROVED' : 'LOG_POST_APPROVED', $log_data['post_subject']);
! 		}
  
! 		if (sizeof($user_posts_sql))
  		{
! 			// Try to minimize the query count by merging users with the same post count additions
! 			$user_posts_update = array();
  
! 			foreach ($user_posts_sql as $user_id => $user_posts)
! 			{
! 				$user_posts_update[$user_posts][] = $user_id;
! 			}
  
! 			foreach ($user_posts_update as $user_posts => $user_id_ary)
  			{
! 				$sql = 'UPDATE ' . USERS_TABLE . '
! 					SET user_posts = user_posts + ' . $user_posts . '
! 					WHERE ' . $db->sql_in_set('user_id', $user_id_ary);
! 				$db->sql_query($sql);
! 			}
! 		}
  
! 		if ($total_topics)
! 		{
! 			set_config_count('num_topics', $total_topics, true);
! 		}
  
! 		if ($total_posts)
! 		{
! 			set_config_count('num_posts', $total_posts, true);
! 		}
  
! 		sync('topic', 'topic_id', array_keys($topic_id_list), true);
! 		sync('forum', 'forum_id', array_keys($forum_id_list), true, true);
! 		unset($topic_id_list, $forum_id_list);
  
! 		$messenger = new messenger();
  
! 		// Notify Poster?
! 		if ($notify_poster)
! 		{
! 			foreach ($post_info as $post_id => $post_data)
  			{
! 				if ($post_data['poster_id'] == ANONYMOUS)
  				{
! 					continue;
  				}
  
! 				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_approved' : 'post_approved';
  
! 				$messenger->template($email_template, $post_data['user_lang']);
  
! 				$messenger->to($post_data['user_email'], $post_data['username']);
! 				$messenger->im($post_data['user_jabber'], $post_data['username']);
  
! 				$messenger->assign_vars(array(
! 					'USERNAME'		=> htmlspecialchars_decode($post_data['username']),
! 					'POST_SUBJECT'	=> htmlspecialchars_decode(censor_text($post_data['post_subject'])),
! 					'TOPIC_TITLE'	=> htmlspecialchars_decode(censor_text($post_data['topic_title'])),
  
! 					'U_VIEW_TOPIC'	=> generate_board_url() . "/viewtopic.$phpEx?f={$post_data['forum_id']}&t={$post_data['topic_id']}&e=0",
! 					'U_VIEW_POST'	=> generate_board_url() . "/viewtopic.$phpEx?f={$post_data['forum_id']}&t={$post_data['topic_id']}&p=$post_id&e=$post_id")
! 				);
  
! 				$messenger->send($post_data['user_notify_type']);
  			}
- 		}
- 
- 		$messenger->save_queue();
  
! 		// Send out normal user notifications
! 		$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
! 
! 		foreach ($post_info as $post_id => $post_data)
! 		{
! 			if ($post_id == $post_data['topic_first_post_id'] && $post_id == $post_data['topic_last_post_id'])
! 			{
! 				// Forum Notifications
! 				user_notification('post', $post_data['topic_title'], $post_data['topic_title'], $post_data['forum_name'], $post_data['forum_id'], $post_data['topic_id'], $post_id);
  			}
! 			else
  			{
! 				// Topic Notifications
! 				user_notification('reply', $post_data['post_subject'], $post_data['topic_title'], $post_data['forum_name'], $post_data['forum_id'], $post_data['topic_id'], $post_id);
  			}
! 		}
! 
! 		if (sizeof($post_id_list) == 1)
! 		{
! 			$post_data = $post_info[$post_id_list[0]];
! 			$post_url = append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f={$post_data['forum_id']}&amp;t={$post_data['topic_id']}&amp;p={$post_data['post_id']}") . '#p' . $post_data['post_id'];
! 		}
! 		unset($post_info);
! 
! 		if ($total_topics)
! 		{
! 			$success_msg = ($total_topics == 1) ? 'TOPIC_APPROVED_SUCCESS' : 'TOPICS_APPROVED_SUCCESS';
  		}
  		else
  		{
! 			$success_msg = (sizeof($post_id_list) + sizeof($post_approved_list) == 1) ? 'POST_APPROVED_SUCCESS' : 'POSTS_APPROVED_SUCCESS';
! 		}
! 	}
! 	else
! 	{
! 		$show_notify = false;
  
! 		if ($config['email_enable'] || $config['jab_enable'])
! 		{
! 			foreach ($post_info as $post_data)
  			{
! 				if ($post_data['poster_id'] == ANONYMOUS)
  				{
! 					continue;
! 				}
! 				else
! 				{
! 					$show_notify = true;
! 					break;
  				}
  			}
- 		}
  
! 		$template->assign_vars(array(
! 			'S_NOTIFY_POSTER'	=> $show_notify,
! 			'S_APPROVE'			=> true)
! 		);
  
! 		confirm_box(false, 'APPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
! 	}
! 
! 	$redirect = request_var('redirect', "index.$phpEx");
! 	$redirect = reapply_sid($redirect);
  
- 	if (!$success_msg)
- 	{
  		redirect($redirect);
  	}
! 	else
  	{
! 		meta_refresh(3, $redirect);
  
! 		// If approving one post, also give links back to post...
! 		$add_message = '';
! 		if (sizeof($post_id_list) == 1 && !empty($post_url))
  		{
! 			$add_message = '<br /><br />' . sprintf($user->lang['RETURN_POST'], '<a href="' . $post_url . '">', '</a>');
  		}
  
! 		trigger_error($user->lang[$success_msg] . '<br /><br />' . sprintf($user->lang['RETURN_PAGE'], "<a href=\"$redirect\">", '</a>') . $add_message);
! 	}
! }
! 
! /**
! * Disapprove Post/Topic
! */
! function disapprove_post($post_id_list, $id, $mode)
! {
! 	global $db, $template, $user, $config;
! 	global $phpEx, $phpbb_root_path;
! 
! 	if (!check_ids($post_id_list, POSTS_TABLE, 'post_id', array('m_approve')))
! 	{
! 		trigger_error('NOT_AUTHORISED');
! 	}
  
! 	$redirect = request_var('redirect', build_url(array('t', 'mode', 'quickmod')) . "&amp;mode=$mode");
! 	$reason = utf8_normalize_nfc(request_var('reason', '', true));
! 	$reason_id = request_var('reason_id', 0);
! 	$success_msg = $additional_msg = '';
! 
! 	$s_hidden_fields = build_hidden_fields(array(
! 		'i'				=> $id,
! 		'mode'			=> $mode,
! 		'post_id_list'	=> $post_id_list,
! 		'action'		=> 'disapprove',
! 		'redirect'		=> $redirect)
! 	);
  
! 	$notify_poster = (isset($_REQUEST['notify_poster'])) ? true : false;
! 	$disapprove_reason = '';
  
! 	if ($reason_id)
! 	{
! 		$sql = 'SELECT reason_title, reason_description
! 			FROM ' . REPORTS_REASONS_TABLE . "
! 			WHERE reason_id = $reason_id";
! 		$result = $db->sql_query($sql);
! 		$row = $db->sql_fetchrow($result);
! 		$db->sql_freeresult($result);
! 
! 		if (!$row || (!$reason && strtolower($row['reason_title']) == 'other'))
! 		{
! 			$additional_msg = $user->lang['NO_REASON_DISAPPROVAL'];
! 			unset($_REQUEST['confirm_key']);
! 			unset($_POST['confirm_key']);
! 			unset($_POST['confirm']);
! 		}
! 		else
  		{
! 			// If the reason is defined within the language file, we will use the localized version, else just use the database entry...
! 			$disapprove_reason = (strtolower($row['reason_title']) != 'other') ? ((isset($user->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])])) ? $user->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])] : $row['reason_description']) : '';
! 			$disapprove_reason .= ($reason) ? "\n\n" . $reason : '';
  
! 			if (isset($user->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])]))
  			{
! 				$disapprove_reason_lang = strtoupper($row['reason_title']);
  			}
  
! 			$email_disapprove_reason = $disapprove_reason;
  		}
- 	}
  
! 	$post_info = get_post_data($post_id_list, 'm_approve');
  
! 	if (confirm_box(true))
! 	{
! 		$disapprove_log = $disapprove_log_topics = $disapprove_log_posts = array();
! 		$topic_replies_real = $post_disapprove_list = array();
! 
! 		// Build a list of posts to be unapproved and get the related topics real replies count
  		foreach ($post_info as $post_id => $post_data)
  		{
! 			$post_disapprove_list[$post_id] = $post_data['topic_id'];
! 			if (!isset($topic_replies_real[$post_data['topic_id']]))
  			{
! 				$topic_replies_real[$post_data['topic_id']] = $post_data['topic_replies_real'];
  			}
  		}
  
! 		// Now we build the log array
! 		foreach ($post_disapprove_list as $post_id => $topic_id)
  		{
! 			// If the count of disapproved posts for the topic is greater
! 			// than topic's real replies count, the whole topic is disapproved/deleted
! 			if (sizeof(array_keys($post_disapprove_list, $topic_id)) > $topic_replies_real[$topic_id])
  			{
! 				// Don't write the log more than once for every topic
! 				if (!isset($disapprove_log_topics[$topic_id]))
  				{
! 					// Build disapproved topics log
! 					$disapprove_log_topics[$topic_id] = array(
! 						'type'			=> 'topic',
! 						'post_subject'	=> $post_info[$post_id]['topic_title'],
! 						'forum_id'		=> $post_info[$post_id]['forum_id'],
! 						'topic_id'		=> 0, // useless to log a topic id, as it will be deleted
! 					);
  				}
  			}
! 			else
  			{
! 				// Build disapproved posts log
! 				$disapprove_log_posts[] = array(
! 					'type'			=> 'post',
! 					'post_subject'	=> $post_info[$post_id]['post_subject'],
! 					'forum_id'		=> $post_info[$post_id]['forum_id'],
! 					'topic_id'		=> $post_info[$post_id]['topic_id'],
! 				);
  
  			}
- 		}
  
! 		// Get disapproved posts/topics counts separately
! 		$num_disapproved_topics = sizeof($disapprove_log_topics);
! 		$num_disapproved_posts = sizeof($disapprove_log_posts);
  
! 		// Build the whole log
! 		$disapprove_log = array_merge($disapprove_log_topics, $disapprove_log_posts);
  
! 		// Unset unneeded arrays
! 		unset($post_data, $disapprove_log_topics, $disapprove_log_posts);
  
! 		// Let's do the job - delete disapproved posts
! 		if (sizeof($post_disapprove_list))
! 		{
! 			if (!function_exists('delete_posts'))
  			{
! 				include_once($phpbb_root_path . 'includes/functions_admin.' . $phpEx);
! 			}
  
! 			// We do not check for permissions here, because the moderator allowed approval/disapproval should be allowed to delete the disapproved posts
! 			// Note: function delete_posts triggers related forums/topics sync,
! 			// so we don't need to call update_post_information later and to adjust real topic replies or forum topics count manually
! 			delete_posts('post_id', array_keys($post_disapprove_list));
  
! 			foreach ($disapprove_log as $log_data)
! 			{
! 				add_log('mod', $log_data['forum_id'], $log_data['topic_id'], ($log_data['type'] == 'topic') ? 'LOG_TOPIC_DISAPPROVED' : 'LOG_POST_DISAPPROVED', $log_data['post_subject'], $disapprove_reason);
  			}
- 		}
  
! 		$messenger = new messenger();
  
- 		// Notify Poster?
- 		if ($notify_poster)
- 		{
  			$lang_reasons = array();
  
  			foreach ($post_info as $post_id => $post_data)
  			{
! 				if ($post_data['poster_id'] == ANONYMOUS)
  				{
! 					continue;
  				}
  
! 				if (isset($disapprove_reason_lang))
  				{
! 					// Okay we need to get the reason from the posters language
! 					if (!isset($lang_reasons[$post_data['user_lang']]))
  					{
! 						// Assign the current users translation as the default, this is not ideal but getting the board default adds another layer of complexity.
! 						$lang_reasons[$post_data['user_lang']] = $user->lang['report_reasons']['DESCRIPTION'][$disapprove_reason_lang];
  
! 						// Only load up the language pack if the language is different to the current one
! 						if ($post_data['user_lang'] != $user->lang_name && file_exists($phpbb_root_path . '/language/' . $post_data['user_lang'] . '/mcp.' . $phpEx))
  						{
! 							// Load up the language pack
! 							$lang = array();
! 							@include($phpbb_root_path . '/language/' . basename($post_data['user_lang']) . '/mcp.' . $phpEx);
  
! 							// If we find the reason in this language pack use it
! 							if (isset($lang['report_reasons']['DESCRIPTION'][$disapprove_reason_lang]))
  							{
! 								$lang_reasons[$post_data['user_lang']] = $lang['report_reasons']['DESCRIPTION'][$disapprove_reason_lang];
! 							}
  
! 							unset($lang); // Free memory
  						}
  					}
  
! 					$email_disapprove_reason = $lang_reasons[$post_data['user_lang']];
! 					$email_disapprove_reason .= ($reason) ? "\n\n" . $reason : '';
  				}
  
! 				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_disapproved' : 'post_disapproved';
! 
! 				$messenger->template($email_template, $post_data['user_lang']);
! 
! 				$messenger->to($post_data['user_email'], $post_data['username']);
! 				$messenger->im($post_data['user_jabber'], $post_data['username']);
! 
! 				$messenger->assign_vars(array(
! 					'USERNAME'		=> htmlspecialchars_decode($post_data['username']),
! 					'REASON'		=> htmlspecialchars_decode($email_disapprove_reason),
! 					'POST_SUBJECT'	=> htmlspecialchars_decode(censor_text($post_data['post_subject'])),
! 					'TOPIC_TITLE'	=> htmlspecialchars_decode(censor_text($post_data['topic_title'])))
! 				);
! 
! 				$messenger->send($post_data['user_notify_type']);
  			}
  
! 			unset($lang_reasons);
! 		}
! 		unset($post_info, $disapprove_reason, $email_disapprove_reason, $disapprove_reason_lang);
  
! 		$messenger->save_queue();
  
! 		if ($num_disapproved_topics)
! 		{
! 			$success_msg = ($num_disapproved_topics == 1) ? 'TOPIC_DISAPPROVED_SUCCESS' : 'TOPICS_DISAPPROVED_SUCCESS';
  		}
  		else
  		{
! 			$success_msg = ($num_disapproved_posts == 1) ? 'POST_DISAPPROVED_SUCCESS' : 'POSTS_DISAPPROVED_SUCCESS';
! 		}
! 	}
! 	else
! 	{
! 		include_once($phpbb_root_path . 'includes/functions_display.' . $phpEx);
  
! 		display_reasons($reason_id);
  
! 		$show_notify = false;
  
! 		foreach ($post_info as $post_data)
! 		{
! 			if ($post_data['poster_id'] == ANONYMOUS)
  			{
! 				continue;
  			}
  			else
  			{
! 				$show_notify = true;
! 				break;
! 			}
! 		}
  
! 		$template->assign_vars(array(
! 			'S_NOTIFY_POSTER'	=> $show_notify,
! 			'S_APPROVE'			=> false,
! 			'REASON'			=> $reason,
! 			'ADDITIONAL_MSG'	=> $additional_msg)
! 		);
  
! 		confirm_box(false, 'DISAPPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
! 	}
  
! 	$redirect = request_var('redirect', "index.$phpEx");
! 	$redirect = reapply_sid($redirect);
  
- 	if (!$success_msg)
- 	{
  		redirect($redirect);
  	}
- 	else
- 	{
- 		meta_refresh(3, $redirect);
- 		trigger_error($user->lang[$success_msg] . '<br /><br />' . sprintf($user->lang['RETURN_PAGE'], "<a href=\"$redirect\">", '</a>'));
- 	}
  }
- 
- ?>--- 714,1568 ----
  						'U_POST_AUTHOR'			=> get_username_string('profile', $row['poster_id'], $row['username'], $row['user_colour'], $row['post_username']),
  
  						'POST_ID'		=> $row['post_id'],
! 						'TOPIC_ID'		=> $row['topic_id'],
! 						'FORUM_NAME'	=> $forum_names[$row['forum_id']],
  						'POST_SUBJECT'	=> ($row['post_subject'] != '') ? $row['post_subject'] : $user->lang['NO_SUBJECT'],
  						'TOPIC_TITLE'	=> $row['topic_title'],
! 						'POST_TIME'		=> $user->format_date($row['post_time']),
! 						'ATTACH_ICON_IMG'	=> ($auth->acl_get('u_download') && $auth->acl_get('f_download', $row['forum_id']) && $row['post_attachment']) ? $user->img('icon_topic_attach', $user->lang['TOTAL_ATTACHMENTS']) : '',
! 					));
  				}
  				unset($rowset, $forum_names);
  
+ 				$base_url = $this->u_action . "&amp;f=$forum_id&amp;st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir";
+ 				$pagination->generate_template_pagination($base_url, 'pagination', 'start', $total, $config['topics_per_page'], $start);
+ 
  				// Now display the page
  				$template->assign_vars(array(
! 					'L_DISPLAY_ITEMS'		=> (!$is_topics) ? $user->lang['DISPLAY_POSTS'] : $user->lang['DISPLAY_TOPICS'],
! 					'L_EXPLAIN'				=> $user->lang['MCP_QUEUE_' . strtoupper($mode) . '_EXPLAIN'],
! 					'L_TITLE'				=> $user->lang['MCP_QUEUE_' . strtoupper($mode)],
  					'L_ONLY_TOPIC'			=> ($topic_id) ? sprintf($user->lang['ONLY_TOPIC'], $topic_info['topic_title']) : '',
  
  					'S_FORUM_OPTIONS'		=> $forum_options,
  					'S_MCP_ACTION'			=> build_url(array('t', 'f', 'sd', 'st', 'sk')),
! 					'S_TOPICS'				=> $is_topics,
! 					'S_RESTORE'				=> $is_restore,
  
  					'TOPIC_ID'				=> $topic_id,
! 					'TOTAL'					=> $user->lang(((!$is_topics) ? 'VIEW_TOPIC_POSTS' : 'VIEW_FORUM_TOPICS'), (int) $total),
  				));
  
  				$this->tpl_name = 'mcp_queue';
  			break;
  		}
  	}
  
! 	/**
! 	* Approve/Restore posts
! 	*
! 	* @param $action		string	Action we perform on the posts ('approve' or 'restore')
! 	* @param $post_id_list	array	IDs of the posts to approve/restore
! 	* @param $id			mixed	Category of the current active module
! 	* @param $mode			string	Active module
! 	* @return null
! 	*/
! 	static public function approve_posts($action, $post_id_list, $id, $mode)
  	{
! 		global $db, $template, $user, $config, $request, $phpbb_container, $phpbb_dispatcher;
! 		global $phpEx, $phpbb_root_path;
  
! 		if (!phpbb_check_ids($post_id_list, POSTS_TABLE, 'post_id', array('m_approve')))
! 		{
! 			trigger_error('NOT_AUTHORISED');
! 		}
  
! 		$redirect = $request->variable('redirect', build_url(array('quickmod')));
! 		$redirect = reapply_sid($redirect);
! 		$success_msg = $post_url = '';
! 		$approve_log = array();
! 		$num_topics = 0;
  
! 		$s_hidden_fields = build_hidden_fields(array(
! 			'i'				=> $id,
! 			'mode'			=> $mode,
! 			'post_id_list'	=> $post_id_list,
! 			'action'		=> $action,
! 			'redirect'		=> $redirect,
! 		));
  
! 		$post_info = phpbb_get_post_data($post_id_list, 'm_approve');
  
! 		if (confirm_box(true))
! 		{
! 			$notify_poster = ($action == 'approve' && isset($_REQUEST['notify_poster']));
  
! 			$topic_info = array();
  
! 			// Group the posts by topic_id
! 			foreach ($post_info as $post_id => $post_data)
  			{
! 				if ($post_data['post_visibility'] == ITEM_APPROVED)
! 				{
! 					continue;
! 				}
! 				$topic_id = (int) $post_data['topic_id'];
  
! 				$topic_info[$topic_id]['posts'][] = (int) $post_id;
! 				$topic_info[$topic_id]['forum_id'] = (int) $post_data['forum_id'];
! 
! 				// Refresh the first post, if the time or id is older then the current one
! 				if ($post_id <= $post_data['topic_first_post_id'] || $post_data['post_time'] <= $post_data['topic_time'])
! 				{
! 					$topic_info[$topic_id]['first_post'] = true;
! 				}
! 
! 				// Refresh the last post, if the time or id is newer then the current one
! 				if ($post_id >= $post_data['topic_last_post_id'] || $post_data['post_time'] >= $post_data['topic_last_post_time'])
! 				{
! 					$topic_info[$topic_id]['last_post'] = true;
! 				}
! 
! 				$post_url = append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f={$post_data['forum_id']}&amp;t={$post_data['topic_id']}&amp;p={$post_data['post_id']}") . '#p' . $post_data['post_id'];
! 
! 				$approve_log[] = array(
! 					'forum_id'		=> $post_data['forum_id'],
! 					'topic_id'		=> $post_data['topic_id'],
! 					'post_subject'	=> $post_data['post_subject'],
! 				);
! 			}
  
! 			$phpbb_content_visibility = $phpbb_container->get('content.visibility');
! 			foreach ($topic_info as $topic_id => $topic_data)
  			{
! 				$phpbb_content_visibility->set_post_visibility(ITEM_APPROVED, $topic_data['posts'], $topic_id, $topic_data['forum_id'], $user->data['user_id'], time(), '', isset($topic_data['first_post']), isset($topic_data['last_post']));
  			}
  
! 			foreach ($approve_log as $log_data)
  			{
! 				add_log('mod', $log_data['forum_id'], $log_data['topic_id'], 'LOG_POST_' . strtoupper($action) . 'D', $log_data['post_subject']);
  			}
  
! 			// Only send out the mails, when the posts are being approved
! 			if ($action == 'approve')
  			{
! 				$phpbb_notifications = $phpbb_container->get('notification_manager');
! 
! 				// Handle notifications
! 				foreach ($post_info as $post_id => $post_data)
  				{
! 					// A single topic approval may also happen here, so handle deleting the respective notification.
! 					if (!$post_data['topic_posts_approved'])
! 					{
! 						$phpbb_notifications->delete_notifications('notification.type.topic_in_queue', $post_data['topic_id']);
! 
! 						if ($post_data['post_visibility'] == ITEM_UNAPPROVED)
! 						{
! 							$phpbb_notifications->add_notifications(array('notification.type.topic'), $post_data);
! 						}
! 						if ($post_data['post_visibility'] != ITEM_APPROVED)
! 						{
! 							$num_topics++;
! 						}
! 					}
! 					else
! 					{
! 						// Only add notifications, if we are not reapproving post
! 						// When the topic was already approved, but was edited and
! 						// now needs re-approval, we don't want to notify the users
! 						// again.
! 						if ($post_data['post_visibility'] == ITEM_UNAPPROVED)
! 						{
! 							$phpbb_notifications->add_notifications(array(
! 								'notification.type.bookmark',
! 								'notification.type.post',
! 							), $post_data);
! 						}
! 					}
! 					$phpbb_notifications->add_notifications(array('notification.type.quote'), $post_data);
! 					$phpbb_notifications->delete_notifications('notification.type.post_in_queue', $post_id);
! 
! 					$phpbb_notifications->mark_notifications_read(array(
! 						'notification.type.quote',
! 						'notification.type.bookmark',
! 						'notification.type.post',
! 					), $post_data['post_id'], $user->data['user_id']);
! 
! 					// Notify Poster?
! 					if ($notify_poster)
! 					{
! 						if ($post_data['poster_id'] == ANONYMOUS)
! 						{
! 							continue;
! 						}
! 
! 						if (!$post_data['topic_posts_approved'])
! 						{
! 							$phpbb_notifications->add_notifications('notification.type.approve_topic', $post_data);
! 						}
! 						else
! 						{
! 							$phpbb_notifications->add_notifications('notification.type.approve_post', $post_data);
! 						}
! 					}
  				}
! 			}
  
! 			if ($num_topics >= 1)
! 			{
! 				$success_msg = ($num_topics == 1) ? 'TOPIC_' . strtoupper($action) . 'D_SUCCESS' : 'TOPICS_' . strtoupper($action) . 'D_SUCCESS';
  			}
  			else
  			{
! 				$success_msg = (sizeof($post_info) == 1) ? 'POST_' . strtoupper($action) . 'D_SUCCESS' : 'POSTS_' . strtoupper($action) . 'D_SUCCESS';
  			}
  
! 			/**
! 			 * Perform additional actions during post(s) approval
! 			 *
! 			 * @event core.approve_posts_after
! 			 * @var	string	action				Variable containing the action we perform on the posts ('approve' or 'restore')
! 			 * @var	array	post_info			Array containing info for all posts being approved
! 			 * @var	array	topic_info			Array containing info for all parent topics of the posts
! 			 * @var	int		num_topics			Variable containing number of topics
! 			 * @var bool	notify_poster		Variable telling if the post should be notified or not
! 			 * @var	string	success_msg			Variable containing the language key for the success message
! 			 * @var string	redirect			Variable containing the redirect url
! 			 * @since 3.1.4-RC1
! 			 */
! 			$vars = array(
! 				'action',
! 				'post_info',
! 				'topic_info',
! 				'num_topics',
! 				'notify_poster',
! 				'success_msg',
! 				'redirect',
! 			);
! 			extract($phpbb_dispatcher->trigger_event('core.approve_posts_after', compact($vars)));
! 
! 			meta_refresh(3, $redirect);
! 			$message = $user->lang[$success_msg];
! 
! 			if ($request->is_ajax())
! 			{
! 				$json_response = new \phpbb\json_response;
! 				$json_response->send(array(
! 					'MESSAGE_TITLE'		=> $user->lang['INFORMATION'],
! 					'MESSAGE_TEXT'		=> $message,
! 					'REFRESH_DATA'		=> null,
! 					'visible'			=> true,
! 				));
! 			}
! 			$message .= '<br /><br />' . $user->lang('RETURN_PAGE', '<a href="' . $redirect . '">', '</a>');
! 
! 			// If approving one post, also give links back to post...
! 			if (sizeof($post_info) == 1 && $post_url)
  			{
! 				$message .= '<br /><br />' . $user->lang('RETURN_POST', '<a href="' . $post_url . '">', '</a>');
! 			}
! 			trigger_error($message);
! 		}
! 		else
! 		{
! 			$show_notify = false;
  
! 			if ($action == 'approve')
! 			{
! 				foreach ($post_info as $post_data)
  				{
! 					if (!$post_data['topic_posts_approved'])
! 					{
! 						$num_topics++;
! 					}
! 
! 					if (!$show_notify && $post_data['poster_id'] != ANONYMOUS)
! 					{
! 						$show_notify = true;
! 					}
  				}
  			}
  
! 			$template->assign_vars(array(
! 				'S_NOTIFY_POSTER'			=> $show_notify,
! 				'S_' . strtoupper($action)	=> true,
! 			));
! 
! 			// Create the confirm box message
! 			$action_msg = strtoupper($action);
! 			$num_posts = sizeof($post_id_list) - $num_topics;
! 			if ($num_topics > 0 && $num_posts <= 0)
! 			{
! 				$action_msg .= '_TOPIC' . (($num_topics == 1) ? '' : 'S');
! 			}
! 			else
! 			{
! 				$action_msg .= '_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S');
! 			}
! 			confirm_box(false, $action_msg, $s_hidden_fields, 'mcp_approve.html');
  		}
  
! 		redirect($redirect);
! 	}
  
! 	/**
! 	* Approve/Restore topics
! 	*
! 	* @param $action		string	Action we perform on the posts ('approve' or 'restore')
! 	* @param $topic_id_list	array	IDs of the topics to approve/restore
! 	* @param $id			mixed	Category of the current active module
! 	* @param $mode			string	Active module
! 	* @return null
! 	*/
! 	static public function approve_topics($action, $topic_id_list, $id, $mode)
! 	{
! 		global $db, $template, $user, $config;
! 		global $phpEx, $phpbb_root_path, $request, $phpbb_container, $phpbb_dispatcher;
  
! 		if (!phpbb_check_ids($topic_id_list, TOPICS_TABLE, 'topic_id', array('m_approve')))
  		{
! 			trigger_error('NOT_AUTHORISED');
  		}
  
! 		$redirect = $request->variable('redirect', build_url(array('quickmod')));
! 		$redirect = reapply_sid($redirect);
! 		$success_msg = $topic_url = '';
! 		$approve_log = array();
  
! 		$s_hidden_fields = build_hidden_fields(array(
! 			'i'				=> $id,
! 			'mode'			=> $mode,
! 			'topic_id_list'	=> $topic_id_list,
! 			'action'		=> $action,
! 			'redirect'		=> $redirect,
! 		));
! 
! 		$topic_info = phpbb_get_topic_data($topic_id_list, 'm_approve');
  
! 		if (confirm_box(true))
  		{
! 			$notify_poster = ($action == 'approve' && isset($_REQUEST['notify_poster'])) ? true : false;
  
! 			$phpbb_content_visibility = $phpbb_container->get('content.visibility');
! 			$first_post_ids = array();
  
! 			foreach ($topic_info as $topic_id => $topic_data)
  			{
! 				$phpbb_content_visibility->set_topic_visibility(ITEM_APPROVED, $topic_id, $topic_data['forum_id'], $user->data['user_id'], time(), '');
! 				$first_post_ids[$topic_id] = (int) $topic_data['topic_first_post_id'];
  
! 				$topic_url = append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f={$topic_data['forum_id']}&amp;t={$topic_id}");
  
! 				$approve_log[] = array(
! 					'forum_id'		=> $topic_data['forum_id'],
! 					'topic_id'		=> $topic_data['topic_id'],
! 					'topic_title'	=> $topic_data['topic_title'],
! 				);
! 			}
  
! 			if (sizeof($topic_info) >= 1)
! 			{
! 				$success_msg = (sizeof($topic_info) == 1) ? 'TOPIC_' . strtoupper($action) . 'D_SUCCESS' : 'TOPICS_' . strtoupper($action) . 'D_SUCCESS';
! 			}
  
! 			foreach ($approve_log as $log_data)
! 			{
! 				add_log('mod', $log_data['forum_id'], $log_data['topic_id'], 'LOG_TOPIC_' . strtoupper($action) . 'D', $log_data['topic_title']);
! 			}
  
! 			// Only send out the mails, when the posts are being approved
! 			if ($action == 'approve')
  			{
! 				// Grab the first post text as it's needed for the quote notification.
! 				$sql = 'SELECT topic_id, post_text
! 					FROM ' . POSTS_TABLE . '
! 					WHERE ' . $db->sql_in_set('post_id', $first_post_ids);
! 				$result = $db->sql_query($sql);
! 
! 				while ($row = $db->sql_fetchrow($result))
  				{
! 					$topic_info[$row['topic_id']]['post_text'] = $row['post_text'];
  				}
+ 				$db->sql_freeresult($result);
  
! 				// Handle notifications
! 				$phpbb_notifications = $phpbb_container->get('notification_manager');
  
! 				foreach ($topic_info as $topic_id => $topic_data)
! 				{
! 					$topic_data = array_merge($topic_data, array(
! 						'post_id'		=> $topic_data['topic_first_post_id'],
! 						'post_subject'	=> $topic_data['topic_title'],
! 						'post_time'		=> $topic_data['topic_time'],
! 						'poster_id'		=> $topic_data['topic_poster'],
! 						'post_username'	=> $topic_data['topic_first_poster_name'],
! 					));
  
! 					$phpbb_notifications->delete_notifications('notification.type.topic_in_queue', $topic_id);
  
! 					// Only add notifications, if we are not reapproving post
! 					// When the topic was already approved, but was edited and
! 					// now needs re-approval, we don't want to notify the users
! 					// again.
! 					if ($topic_data['topic_visibility'] == ITEM_UNAPPROVED)
! 					{
! 						$phpbb_notifications->add_notifications(array(
! 							'notification.type.quote',
! 							'notification.type.topic',
! 						), $topic_data);
! 					}
  
! 					$phpbb_notifications->mark_notifications_read('notification.type.quote', $topic_data['post_id'], $user->data['user_id']);
! 					$phpbb_notifications->mark_notifications_read('notification.type.topic', $topic_id, $user->data['user_id']);
  
! 					if ($notify_poster)
! 					{
! 						$phpbb_notifications->add_notifications('notification.type.approve_topic', $topic_data);
! 					}
! 				}
  			}
  
! 			/**
! 			 * Perform additional actions during topics(s) approval
! 			 *
! 			 * @event core.approve_topics_after
! 			 * @var	string	action				Variable containing the action we perform on the posts ('approve' or 'restore')
! 			 * @var	mixed	topic_info			Array containing info for all topics being approved
! 			 * @var	array	first_post_ids		Array containing ids of all first posts
! 			 * @var bool	notify_poster		Variable telling if the poster should be notified or not
! 			 * @var	string	success_msg			Variable containing the language key for the success message
! 			 * @var string	redirect			Variable containing the redirect url
! 			 * @since 3.1.4-RC1
! 			 */
! 			$vars = array(
! 				'action',
! 				'topic_info',
! 				'first_post_ids',
! 				'notify_poster',
! 				'success_msg',
! 				'redirect',
! 			);
! 			extract($phpbb_dispatcher->trigger_event('core.approve_topics_after', compact($vars)));
! 
! 			meta_refresh(3, $redirect);
! 			$message = $user->lang[$success_msg];
! 
! 			if ($request->is_ajax())
! 			{
! 				$json_response = new \phpbb\json_response;
! 				$json_response->send(array(
! 					'MESSAGE_TITLE'		=> $user->lang['INFORMATION'],
! 					'MESSAGE_TEXT'		=> $message,
! 					'REFRESH_DATA'		=> null,
! 					'visible'			=> true,
! 				));
  			}
! 			$message .= '<br /><br />' . $user->lang('RETURN_PAGE', '<a href="' . $redirect . '">', '</a>');
! 
! 			// If approving one topic, also give links back to topic...
! 			if (sizeof($topic_info) == 1 && $topic_url)
  			{
! 				$message .= '<br /><br />' . $user->lang('RETURN_TOPIC', '<a href="' . $topic_url . '">', '</a>');
  			}
! 			trigger_error($message);
  		}
  		else
  		{
! 			$show_notify = false;
  
! 			if ($action == 'approve')
  			{
! 				foreach ($topic_info as $topic_data)
  				{
! 					if ($topic_data['topic_poster'] == ANONYMOUS)
! 					{
! 						continue;
! 					}
! 					else
! 					{
! 						$show_notify = true;
! 						break;
! 					}
  				}
  			}
  
! 			$template->assign_vars(array(
! 				'S_NOTIFY_POSTER'			=> $show_notify,
! 				'S_' . strtoupper($action)	=> true,
! 			));
  
! 			confirm_box(false, strtoupper($action) . '_TOPIC' . ((sizeof($topic_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
! 		}
  
  		redirect($redirect);
  	}
! 
! 	/**
! 	* Disapprove Post
! 	*
! 	* @param $post_id_list	array	IDs of the posts to disapprove/delete
! 	* @param $id			mixed	Category of the current active module
! 	* @param $mode			string	Active module
! 	* @return null
! 	*/
! 	static public function disapprove_posts($post_id_list, $id, $mode)
  	{
! 		global $db, $template, $user, $config, $phpbb_container, $phpbb_dispatcher;
! 		global $phpEx, $phpbb_root_path, $request;
  
! 		if (!phpbb_check_ids($post_id_list, POSTS_TABLE, 'post_id', array('m_approve')))
  		{
! 			trigger_error('NOT_AUTHORISED');
  		}
  
! 		$redirect = $request->variable('redirect', build_url(array('t', 'mode', 'quickmod')) . "&amp;mode=$mode");
! 		$redirect = reapply_sid($redirect);
! 		$reason = $request->variable('reason', '', true);
! 		$reason_id = $request->variable('reason_id', 0);
! 		$success_msg = $additional_msg = '';
  
! 		$s_hidden_fields = build_hidden_fields(array(
! 			'i'				=> $id,
! 			'mode'			=> $mode,
! 			'post_id_list'	=> $post_id_list,
! 			'action'		=> 'disapprove',
! 			'redirect'		=> $redirect,
! 		));
  
! 		$notify_poster = $request->is_set('notify_poster');
! 		$disapprove_reason = '';
  
! 		if ($reason_id)
  		{
! 			$sql = 'SELECT reason_title, reason_description
! 				FROM ' . REPORTS_REASONS_TABLE . "
! 				WHERE reason_id = $reason_id";
! 			$result = $db->sql_query($sql);
! 			$row = $db->sql_fetchrow($result);
! 			$db->sql_freeresult($result);
  
! 			if (!$row || (!$reason && strtolower($row['reason_title']) == 'other'))
  			{
! 				$additional_msg = $user->lang['NO_REASON_DISAPPROVAL'];
! 
! 				$request->overwrite('confirm', null, \phpbb\request\request_interface::POST);
! 				$request->overwrite('confirm_key', null, \phpbb\request\request_interface::POST);
! 				$request->overwrite('confirm_key', null, \phpbb\request\request_interface::REQUEST);
  			}
+ 			else
+ 			{
+ 				// If the reason is defined within the language file, we will use the localized version, else just use the database entry...
+ 				$disapprove_reason = (strtolower($row['reason_title']) != 'other') ? ((isset($user->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])])) ? $user->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])] : $row['reason_description']) : '';
+ 				$disapprove_reason .= ($reason) ? "\n\n" . $reason : '';
  
! 				if (isset($user->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])]))
! 				{
! 					$disapprove_reason_lang = strtoupper($row['reason_title']);
! 				}
! 			}
  		}
  
! 		$post_info = phpbb_get_post_data($post_id_list, 'm_approve');
  
! 		$is_disapproving = false;
  		foreach ($post_info as $post_id => $post_data)
  		{
! 			if ($post_data['post_visibility'] == ITEM_DELETED)
  			{
! 				continue;
  			}
+ 
+ 			$is_disapproving = true;
  		}
  
! 		if (confirm_box(true))
  		{
! 			$disapprove_log = $disapprove_log_topics = $disapprove_log_posts = array();
! 			$topic_posts_unapproved = $post_disapprove_list = $topic_information = array();
! 
! 			// Build a list of posts to be disapproved and get the related topics real replies count
! 			foreach ($post_info as $post_id => $post_data)
  			{
! 				$post_disapprove_list[$post_id] = $post_data['topic_id'];
! 				if (!isset($topic_posts_unapproved[$post_data['topic_id']]))
  				{
! 					$topic_information[$post_data['topic_id']] = $post_data;
! 					$topic_posts_unapproved[$post_data['topic_id']] = 0;
  				}
+ 				$topic_posts_unapproved[$post_data['topic_id']]++;
  			}
! 
! 			// Now we build the log array
! 			foreach ($post_disapprove_list as $post_id => $topic_id)
  			{
! 				// If the count of disapproved posts for the topic is equal
! 				// to the number of unapproved posts in the topic, and there are no different
! 				// posts, we disapprove the hole topic
! 				if ($topic_information[$topic_id]['topic_posts_approved'] == 0 &&
! 					$topic_information[$topic_id]['topic_posts_softdeleted'] == 0 &&
! 					$topic_information[$topic_id]['topic_posts_unapproved'] == $topic_posts_unapproved[$topic_id])
! 				{
! 					// Don't write the log more than once for every topic
! 					if (!isset($disapprove_log_topics[$topic_id]))
! 					{
! 						// Build disapproved topics log
! 						$disapprove_log_topics[$topic_id] = array(
! 							'type'			=> 'topic',
! 							'post_subject'	=> $post_info[$post_id]['topic_title'],
! 							'forum_id'		=> $post_info[$post_id]['forum_id'],
! 							'topic_id'		=> 0, // useless to log a topic id, as it will be deleted
! 							'post_username'	=> ($post_info[$post_id]['poster_id'] == ANONYMOUS && !empty($post_info[$post_id]['post_username'])) ? $post_info[$post_id]['post_username'] : $post_info[$post_id]['username'],
! 						);
! 					}
! 				}
! 				else
! 				{
! 					// Build disapproved posts log
! 					$disapprove_log_posts[] = array(
! 						'type'			=> 'post',
! 						'post_subject'	=> $post_info[$post_id]['post_subject'],
! 						'forum_id'		=> $post_info[$post_id]['forum_id'],
! 						'topic_id'		=> $post_info[$post_id]['topic_id'],
! 						'post_username'	=> ($post_info[$post_id]['poster_id'] == ANONYMOUS && !empty($post_info[$post_id]['post_username'])) ? $post_info[$post_id]['post_username'] : $post_info[$post_id]['username'],
! 					);
  
+ 				}
  			}
  
! 			// Get disapproved posts/topics counts separately
! 			$num_disapproved_topics = sizeof($disapprove_log_topics);
! 			$num_disapproved_posts = sizeof($disapprove_log_posts);
  
! 			// Build the whole log
! 			$disapprove_log = array_merge($disapprove_log_topics, $disapprove_log_posts);
  
! 			// Unset unneeded arrays
! 			unset($post_data, $disapprove_log_topics, $disapprove_log_posts);
  
! 			// Let's do the job - delete disapproved posts
! 			if (sizeof($post_disapprove_list))
  			{
! 				if (!function_exists('delete_posts'))
! 				{
! 					include($phpbb_root_path . 'includes/functions_admin.' . $phpEx);
! 				}
  
! 				// We do not check for permissions here, because the moderator allowed approval/disapproval should be allowed to delete the disapproved posts
! 				// Note: function delete_posts triggers related forums/topics sync,
! 				// so we don't need to call update_post_information later and to adjust real topic replies or forum topics count manually
! 				delete_posts('post_id', array_keys($post_disapprove_list));
  
! 				foreach ($disapprove_log as $log_data)
! 				{
! 					if ($is_disapproving)
! 					{
! 						$l_log_message = ($log_data['type'] == 'topic') ? 'LOG_TOPIC_DISAPPROVED' : 'LOG_POST_DISAPPROVED';
! 						add_log('mod', $log_data['forum_id'], $log_data['topic_id'], $l_log_message, $log_data['post_subject'], $disapprove_reason, $log_data['post_username']);
! 					}
! 					else
! 					{
! 						$l_log_message = ($log_data['type'] == 'topic') ? 'LOG_DELETE_TOPIC' : 'LOG_DELETE_POST';
! 						add_log('mod', $log_data['forum_id'], $log_data['topic_id'], $l_log_message, $log_data['post_subject'], $log_data['post_username']);
! 					}
! 				}
  			}
  
! 			$phpbb_notifications = $phpbb_container->get('notification_manager');
  
  			$lang_reasons = array();
  
  			foreach ($post_info as $post_id => $post_data)
  			{
! 				$disapprove_all_posts_in_topic = $topic_information[$topic_id]['topic_posts_approved'] == 0 &&
! 					$topic_information[$topic_id]['topic_posts_softdeleted'] == 0 &&
! 					$topic_information[$topic_id]['topic_posts_unapproved'] == $topic_posts_unapproved[$topic_id];
! 
! 				$phpbb_notifications->delete_notifications('notification.type.post_in_queue', $post_id);
! 
! 				// Do we disapprove the whole topic? Remove potential notifications
! 				if ($disapprove_all_posts_in_topic)
  				{
! 					$phpbb_notifications->delete_notifications('notification.type.topic_in_queue', $post_data['topic_id']);
  				}
  
! 				// Notify Poster?
! 				if ($notify_poster)
  				{
! 					if ($post_data['poster_id'] == ANONYMOUS)
  					{
! 						continue;
! 					}
  
! 					$post_data['disapprove_reason'] = '';
! 					if (isset($disapprove_reason_lang))
! 					{
! 						// Okay we need to get the reason from the posters language
! 						if (!isset($lang_reasons[$post_data['user_lang']]))
  						{
! 							// Assign the current users translation as the default, this is not ideal but getting the board default adds another layer of complexity.
! 							$lang_reasons[$post_data['user_lang']] = $user->lang['report_reasons']['DESCRIPTION'][$disapprove_reason_lang];
  
! 							// Only load up the language pack if the language is different to the current one
! 							if ($post_data['user_lang'] != $user->lang_name && file_exists($phpbb_root_path . '/language/' . $post_data['user_lang'] . '/mcp.' . $phpEx))
  							{
! 								// Load up the language pack
! 								$lang = array();
! 								@include($phpbb_root_path . '/language/' . basename($post_data['user_lang']) . '/mcp.' . $phpEx);
! 
! 								// If we find the reason in this language pack use it
! 								if (isset($lang['report_reasons']['DESCRIPTION'][$disapprove_reason_lang]))
! 								{
! 									$lang_reasons[$post_data['user_lang']] = $lang['report_reasons']['DESCRIPTION'][$disapprove_reason_lang];
! 								}
  
! 								unset($lang); // Free memory
! 							}
  						}
+ 
+ 						$post_data['disapprove_reason'] = $lang_reasons[$post_data['user_lang']];
+ 						$post_data['disapprove_reason'] .= ($reason) ? "\n\n" . $reason : '';
  					}
  
! 					if ($disapprove_all_posts_in_topic && $topic_information[$topic_id]['topic_posts_unapproved'] == 1)
! 					{
! 						// If there is only 1 post when disapproving the topic,
! 						// we send the user a "disapprove topic" notification...
! 						$phpbb_notifications->add_notifications('notification.type.disapprove_topic', $post_data);
! 					}
! 					else
! 					{
! 						// ... otherwise there are multiple unapproved posts and
! 						// all of them are disapproved as posts.
! 						$phpbb_notifications->add_notifications('notification.type.disapprove_post', $post_data);
! 					}
  				}
+ 			}
  
! 			if ($num_disapproved_topics)
! 			{
! 				$success_msg = ($num_disapproved_topics == 1) ? 'TOPIC' : 'TOPICS';
! 			}
! 			else
! 			{
! 				$success_msg = ($num_disapproved_posts == 1) ? 'POST' : 'POSTS';
  			}
  
! 			if ($is_disapproving)
! 			{
! 				$success_msg .= '_DISAPPROVED_SUCCESS';
! 			}
! 			else
! 			{
! 				$success_msg .= '_DELETED_SUCCESS';
! 			}
  
! 			// If we came from viewtopic, we try to go back to it.
! 			if (strpos($redirect, $phpbb_root_path . 'viewtopic.' . $phpEx) === 0)
! 			{
! 				if ($num_disapproved_topics == 0)
! 				{
! 					// So we need to remove the post id part from the Url
! 					$redirect = str_replace("&amp;p={$post_id_list[0]}#p{$post_id_list[0]}", '', $redirect);
! 				}
! 				else
! 				{
! 					// However this is only possible if the topic still exists,
! 					// Otherwise we go back to the viewforum page
! 					$redirect = append_sid($phpbb_root_path . 'viewforum.' . $phpEx, 'f=' . $request->variable('f', 0));
! 				}
! 			}
  
! 			/**
! 			 * Perform additional actions during post(s) disapproval
! 			 *
! 			 * @event core.disapprove_posts_after
! 			 * @var	array	post_info					Array containing info for all posts being disapproved
! 			 * @var	array	topic_information			Array containing information for the topics
! 			 * @var	array	topic_posts_unapproved		Array containing list of topic ids and the count of disapproved posts in them
! 			 * @var	array	post_disapprove_list		Array containing list of posts and their topic id
! 			 * @var	int		num_disapproved_topics		Variable containing the number of disapproved topics
! 			 * @var	int		num_disapproved_posts		Variable containing the number of disapproved posts
! 			 * @var array	lang_reasons				Array containing the language keys for reasons
! 			 * @var	string	disapprove_reason			Variable containing the language key for the success message
! 			 * @var	string	disapprove_reason_lang		Variable containing the language key for the success message
! 			 * @var bool	is_disapproving				Variable telling if anything is going to be disapproved
! 			 * @var bool	notify_poster				Variable telling if the post should be notified or not
! 			 * @var	string	success_msg					Variable containing the language key for the success message
! 			 * @var string	redirect					Variable containing the redirect url
! 			 * @since 3.1.4-RC1
! 			 */
! 			$vars = array(
! 				'post_info',
! 				'topic_information',
! 				'topic_posts_unapproved',
! 				'post_disapprove_list',
! 				'num_disapproved_topics',
! 				'num_disapproved_posts',
! 				'lang_reasons',
! 				'disapprove_reason',
! 				'disapprove_reason_lang',
! 				'is_disapproving',
! 				'notify_poster',
! 				'success_msg',
! 				'redirect',
! 			);
! 			extract($phpbb_dispatcher->trigger_event('core.disapprove_posts_after', compact($vars)));
! 
! 			unset($lang_reasons, $post_info, $disapprove_reason, $disapprove_reason_lang);
! 
! 			meta_refresh(3, $redirect);
! 			$message = $user->lang[$success_msg];
! 
! 			if ($request->is_ajax())
! 			{
! 				$json_response = new \phpbb\json_response;
! 				$json_response->send(array(
! 					'MESSAGE_TITLE'		=> $user->lang['INFORMATION'],
! 					'MESSAGE_TEXT'		=> $message,
! 					'REFRESH_DATA'		=> null,
! 					'visible'			=> false,
! 				));
! 			}
! 			$message .= '<br /><br />' . $user->lang('RETURN_PAGE', '<a href="' . $redirect . '">', '</a>');
! 			trigger_error($message);
  		}
  		else
  		{
! 			if (!function_exists('display_reasons'))
! 			{
! 				include($phpbb_root_path . 'includes/functions_display.' . $phpEx);
! 			}
  
! 			$show_notify = false;
  
! 			foreach ($post_info as $post_data)
! 			{
! 				if ($post_data['poster_id'] == ANONYMOUS)
! 				{
! 					continue;
! 				}
! 				else
! 				{
! 					$show_notify = true;
! 					break;
! 				}
! 			}
  
! 			$l_confirm_msg = 'DISAPPROVE_POST';
! 			$confirm_template = 'mcp_approve.html';
! 			if ($is_disapproving)
  			{
! 				display_reasons($reason_id);
  			}
  			else
  			{
! 				$user->add_lang('posting');
  
! 				$l_confirm_msg = 'DELETE_POST_PERMANENTLY';
! 				$confirm_template = 'confirm_delete_body.html';
! 			}
! 			$l_confirm_msg .= ((sizeof($post_id_list) == 1) ? '' : 'S');
  
! 			$template->assign_vars(array(
! 				'S_NOTIFY_POSTER'	=> $show_notify,
! 				'S_APPROVE'			=> false,
! 				'REASON'			=> ($is_disapproving) ? $reason : '',
! 				'ADDITIONAL_MSG'	=> $additional_msg,
! 			));
  
! 			confirm_box(false, $l_confirm_msg, $s_hidden_fields, $confirm_template);
! 		}
  
  		redirect($redirect);
  	}
  }
